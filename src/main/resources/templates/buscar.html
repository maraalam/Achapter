<!DOCTYPE html>
<html class="h-100" xmlns:th="http://www.thymeleaf.org">

<head>
    <th:block th:replace="fragments/head :: header" />
    
    <title>Búsqueda</title>
</head>

<body class="d-flex flex-column h-100">
    <header th:replace="fragments/nav.html :: nav"></header>
    <main class="flex-shrink-0">

    <div class="container">
        <div class="row">
            <!--Columna filtros md(en pantallas pequeñas las dos columnas se convierten en filas)-->
            <div class="col-md-3">

                <!-- Sidebar filter section -->
                <section class="filters">        
                    <h1>Búsqueda</h1>
                    <br><br>
                
                    <div class="border-bottom pb-2 ml-2">
                        <h4>Filtros</h4>
                    </div>

                    <div class="d-flex flex-row">        
                        <div class="ml-auto mr-lg-4">
                            <div id="sorting" class="border rounded p-1 m-1"> <span class="text-muted">Tipo </span> <select name="sort" id="sort">
                                    <option value="titulo"><b>Titulo</b></option>
                                    <option value="isbn"><b>ISBN</b></option>
                                    <option value="usuario"><b>Usuarios</b></option>
                                </select> </div>
                        </div>
                    </div>
                    
                    <div class="py-2 border-bottom ml-3">
                        <div class="d-flex flex-row">        
                            <div class="ml-auto mr-lg-4">
                                <div id="type" class="border rounded p-1 m-1"> <span class="text-muted">Ordenar por </span> <select name="sort" id="sort">
                                        <option value="popularity"><b>Popularidad</b></option>
                                        <option value="prcie"><b>Fecha</b></option>
                                        <option value="rating"><b>Rating</b></option>
                                    </select> </div>
                            </div>
                        </div>
                    </div>
                    <div class="py-2 border-bottom ml-3">
                        <h6 class="font-weight-bold">Autor</h6>
                        <div id="orange"><span class="fa fa-minus"></span></div>            
                        <div class="input-group mb-2 border rounded-pill">
                            <input id="searchPorAutor" onkeyup="buscarAutorFiltro()" type="search" placeholder="Buscar por autor..." aria-describedby="button-addon3" class="form-control bg-none border-0">
                            <div class="input-group-append border-0">
                            <button id="button-addon3" type="button" class="btn btn-link text-success"><i class="fa fa-search"></i></button>
                            </div>
                        </div>
                        <form class="row autores-filter pt-3">
                            <div th:each="autor: ${booksAutores}" class="filtro-autores" >
                                <div class="products-single fix">
                                    <div class="form-group">
                                        <input type="checkbox" th:id="${autor}" onclick="filtrar()">
                                        <label th:for="${autor}" th:text="${autor}">Autor</label>
                                    </div>
                                </div>
                            
                            </div>
                            
                        </form>
                    </div>


                    <div class="py-2 border-bottom ml-3">
                        <h6 class="font-weight-bold">Género</h6>
                        <div id="orange"><span class="fa fa-minus"></span></div>            
                        <div class="input-group mb-2 border rounded-pill">
                            <input id="searchPorGenero" onkeyup="buscarGeneroFiltro()" type="search" placeholder="Buscar por género..." aria-describedby="button-addon3" class="form-control bg-none border-0">
                            <div class="input-group-append border-0">
                            <button id="button-addon3" type="button" class="btn btn-link text-success"><i class="fa fa-search"></i></button>
                            </div>
                        </div>
                        <form class="row generos-filter pt-3">
                            <div th:each="genero: ${generos}" class="filtro-generos" >
                                <div class="products-single fix">
                                    <div class="form-group">
                                        <input type="checkbox" th:id="${genero}" onclick="filtrar()">
                                        <label th:for="${genero}" th:text="${genero}">Genero</label>
                                    </div>
                                </div>
                            
                            </div>
                            
                        </form>
                    </div>


            
                    <div class="py-2 border-bottom ml-3">
                        <h6 class="font-weight-bold">Fecha de publicación</h6>
                        <div id="orange"><span class="fa fa-minus"></span></div>
                        <form>
                            <div class="form-group"> <input type="checkbox" id="tea"> <label for="tea">2022</label> </div>
                            <div class="form-group"> <input type="checkbox" id="cookies"> <label for="cookies">2021</label> </div>
                            <div class="form-group"> <input type="checkbox" id="pastries"> <label for="pastries">2020</label> </div>
                        </form>
                    </div>
                
                </section>
                
            </div>

            <!--Columna resultados-->          
            <div class="col-md-9">
                <section>
                    <div class="input-group mb-n2 border rounded-pill">
                        <input id="search-text" onkeyup="filtrar()" placeholder="Búsqueda avanzada" aria-describedby="button-addon3" class="form-control bg-none border-0 search-advanced">
                        <div class="input-group-append border-0">
                        <button id="button-addon3" type="button" class="btn btn-link text-success"><i class="fa fa-search"></i></button>
                        </div>
                    </div>
                </section>

                <!-- RESULTADOS DE LA BÚSQUEDA  -->
                <div class="products-box" >

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="title-all ">
                                <h4>Resultados</h4>
                            </div>
                        </div>
                    </div>
                    

                    <div class="row special-list" id="results" >
                        <div th:each="book: ${books}" class="col-lg-3 col-md-6 special-grid best-seller" >
                            <div class="products-single fix">
                                <div class="box-img-hover">
                                    <div class="book-img book-img-buscar"> 
                                        <img th:src="${book.portada}" src="https://i.pinimg.com/564x/f9/d8/99/f9d899d2d0f9676e89ba4ab83d85bd45.jpg" />
                                    </div>  
                                    <form class="mask-icon" th:action="@{/save/quieroLeer/__${book.id}__}" method="POST">
                                        <button id="addToLib" class="cart cart-buscar" type="submit">Agregar a mi biblioteca</button>
                                    </form>
                                </div>

                                <a th:href=@{/libro/{id}(id=${book.id})} href="/libro/"{id}(id=${book.id}) class="text-decoration-none link-dark">
                                    <div class="why-text">  
                                        <h3 class="titulo-libro-buscar" th:text="${book.titulo}" >Nombre del libro</h3>
                                        <h5 class="isbn-libro" th:text="${book.ISBN}" hidden>isbn</h5>
                                        <h5 class="genero-libro" th:text="${book.generos}" hidden>genero</h5>
                                        <h6 class="autor-libro" th:text="${book.autor}"> Por Autor</h6>
                                        <div class="product-rating mb-2">
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star mr-0"></i>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>     
                    </div>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css"   integrity="sha256-2XFplPlrFClt0bIdPgpz8H7ojnk10H69xRqd9+uTShA=" crossorigin="anonymous" />
    
    <script th:inline="javascript">
        function changeSearch() {
            //https://stackoverflow.com/questions/4842590/how-to-run-a-function-when-the-page-is-loaded
            var result_query = null, result_type, tmp = [];
            location.search
                .substr(1)
                .split("&")
                .forEach(function (item) {
                tmp = item.split("=");
                if (tmp[0] === "query") result_query = decodeURIComponent(tmp[1]);
                });
                document.getElementById("search-text").value = result_query;

                location.search
                .substr(1)
                .split("&")
                .forEach(function (item) {
                tmp = item.split("=");
                if (tmp[0] === "type") result_type = decodeURIComponent(tmp[1]);
                });
                
                var types = document.querySelector('#sorting option[value='+result_type+']');
                types.selected = "selected";
            filtrar();
        }
        window.addEventListener('load', changeSearch);
        


        function buscarAutorFiltro(){
            console.log("buscando autor...");
            var search = document.getElementById("searchPorAutor").value;
            var autores = document.getElementsByClassName("filtro-autores");

            console.log(search);
            for(let autor of autores){
                let autorNombre = autor.getElementsByTagName("label")[0].innerHTML;

                if (search === ""){
                    autor.style.display = "block";
                }
                else if (autorNombre.toLowerCase().search(search.toLowerCase())!=0){
                    autor.style.display = "none";
                }
                else{
                    autor.style.display = "block";
                }
            }
        }

        function buscarGeneroFiltro(){
            console.log("buscando genero...");
            var search = document.getElementById("searchPorGenero").value;
            var generos = document.getElementsByClassName("filtro-generos");

            console.log(search);
            for(let genero of generos){
                let generosNombre = genero.getElementsByTagName("label")[0].innerHTML;

                if (search === ""){
                    genero.style.display = "block";
                }
                else if (generosNombre.toLowerCase().search(search.toLowerCase())!=0){
                    genero.style.display = "none";
                }
                else{
                    genero.style.display = "block";
                }
            }
        }
        
        function filtrar(){
            console.log("buscando y filtrando...");

            /*Tipo de búsqueda*/
            var e = document.getElementById("sort");
            var type_search = e[e.selectedIndex].value; 
            var search = document.getElementById("search-text").value;

            /*Filtro de autores*/
            var autores = document.getElementsByClassName("autores-filter")[0];
            autores = autores.getElementsByTagName("input");

            /*Filtro de generos*/
            var generos = document.getElementsByClassName("generos-filter")[0];
            generos = generos.getElementsByTagName("input");
                        

            var librosMostrar = []

            for(let r of document.getElementsByClassName("best-seller")){
                let generoLibro = r.getElementsByClassName("genero-libro")[0].innerHTML;
                let autorlibro = r.getElementsByClassName("autor-libro")[0].innerHTML;
                let isbn = r.getElementsByClassName("isbn-libro")[0].innerHTML;
                let titulo = r.getElementsByClassName("titulo-libro-buscar")[0].innerHTML;

                var incluir = true;

                if (search === ""){
                    incluir=true
                }
                else if (type_search.localeCompare("titulo")==0 &&
                titulo.toLowerCase().search(search.toLowerCase())==-1){
                    incluir = false;
                }
                else if (type_search.localeCompare("isbn")==0 &&
                isbn.toLowerCase().search(search.toLowerCase())==-1){
                    incluir = false;
                }
                else{
                    incluir=true
                }

                
                if(incluir){
                    for(let a in autores){             
                        if(!autores[a].checked){                        
                            incluir = incluir && true;
                        }  
                        else if(autores[a].checked && autores[a].id.search(autorlibro)==0){
                            incluir = true;
                            break;                              
                        }
                        else{
                            incluir = false;
                        }   
                    }
                }

                if(incluir){
                              
                    generoLibro = generoLibro.split(",")
                    for(let g in generos){              

                        if(!generos[g].checked){                        
                            incluir = incluir && true;
                        }  
                        else if(generos[g].checked && generoLibro.includes(generos[g].id)){
                            incluir = true;
                            break;
                        }
                        else{
                            incluir = false;
                        }   
                    }
                }
                
                if(incluir){
                    r.style.display = "block";
                }        
                else{
                    r.style.display = "none";
                }
            }
        }
        
    </script>
    </main>

    <th:block th:replace="fragments/footer.html :: footer" />
</body>

</html>